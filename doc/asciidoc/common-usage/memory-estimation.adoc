[[memory-estimation]]
= Memory Estimation

[abstract]
--
This section describes how to estimate memory requirements for the projected graph model used by the Neo4j Graph Data Science library.
--

The graph algorithms library operates completely on the heap, which means we'll need to configure our Neo4j Server with a much larger heap size than we would for transactional workloads.
The diagram belows shows how memory is used by the projected graph model:

image::graph-model-memory.png[width=500]

The model contains three types of data:

* Node ids - up to 2^45^ ("35 trillion")
* Relationships - pairs of node ids. Relationships are stored twice if `orientation: "UNDIRECTED"` is used.
* Weights - stored as doubles (8 bytes per node) in an array-like data structure next to the relationships

Memory configuration depends on the graph projection that we're using.

This section includes:

* <<estimate-procedure-algo>>
* <<estimate-procedure-graph>>

[[estimate-procedure-algo]]
== Estimating memory requirements for algorithms

In many use cases it will be useful to estimate the required memory of a graph and an algorithm before running it in order to make sure that the workload can run on the available hardware.
To make this process easier every algorithm supports the `.estimate` mode, which returns an estimate of the amount of memory required to run graph algorithms.

.Syntax
[source, cypher]
----
CALL gds.<ALGO>.<MODE>.estimate(graphNameOrConfig: String|Map, configuration: Map})
YIELD requiredMemory, treeView, mapView, bytesMin, bytesMax, nodeCount, relationshipCount
----

.Parameters
[opts="header",cols="1,1,1,1,4"]
|===
| Name              | Type          | Default   | Optional  | Description
| graphNameOrConfig | string or map | -         | no        | The name of the projected graph or the algorithm configuration in case of implicit loading.
| config            | map           | {}        | yes       | If the first parameter is the name of a projected graph, this parameter is the algorithm config, otherwise it needs to be null or an empty map.
|===

The configuration parameter accepts the same configuration parameters as the estimated algorithm.
See the algorithm documentation for more information.

.Results
[opts="header",cols="1,1,6"]
|===
| Name                  | Type      | Description
| requiredMemory        | string    | An estimation of the required memory in a human readable format.
| treeView              | string    | A more detailed, human readable representation of the required memory, including estimates of the different components.
| mapView               | string    | A more detailed representation of the required memory, including estimates of the different components.
| bytesMin              | int       | The minimum number of bytes required.
| bytesMax              | int       | The maximum number of bytes required.
| nodeCount             | int       | The estimated number of nodes in the graph
| relationshipCount     | int       | The estimated number of relationships in the graph
|===

[[estimate-procedure-graph]]
== Estimating memory requirements for graphs

The <<catalog-graph-create, `gds.graph.create`>> procedures also support `.estimate` to estimate memory usage for just the graph.
Those procedures don't accept the graph name as the first argument, as they don't actually create the graph.

.Syntax
[source, cypher]
----
CALL gds.graph.create.estimate(nodeProjection: String|List|Map, relationshipProjection: String|List|Map, configuration: Map})
YIELD requiredMemory, treeView, mapView, bytesMin, bytesMax, nodeCount, relationshipCount
----

The `nodeProjection` and `relationshipProjection` parameters follow the same syntax as in <<catalog-graph-create, `gds.graph.create`>>.

.Parameters
[opts="header",cols="1,1,1,1,4"]
|===
| Name                   | Type                  | Default   | Optional  | Description
| nodeProjection         | string or list or map | -         | no        | The node projection to estimate for.
| relationshipProjection | string or list or map | -         | no        | The relationship projection to estimate for.
| config                 | map                   | {}        | yes       | Additional configuration, such as concurrency.
|===

It is furthermore possible to estimate the memory of a graph, by explicitly specifying its number of nodes and relationships.
This will work even if no graph with such node and relationship counts exists in the database.
To achieve this, use the following configuration options:

.Configuration
[opts="header",cols="1,1,1,1,4"]
|===
| Name              | Type      | Default           | Optional  | Description
| nodeCount         | int       | 0                 | yes       | The number of nodes in a fictive graph.
| relationshipCount | int       | 0                 | yes       | The number of relationships in a fictive graph.
|===

In estimating a fictive graph, syntactically valid `nodeProjection` and `relationshipProjection` need to be specified.
However, it is recommended to specify `'*'` for both in the fictive graph case as this does not interfere with the specified values above.

The query below is an example of estimating a fictive graph with 100 nodes and 1000 relationships.

.Example
[source, cypher]
----
CALL gds.graph.create.estimate('*', '*', {
  nodeCount: 100,
  relationshipCount: 1000,
  nodeProperties: 'foo',
  relationshipProperties: 'bar'
})
YIELD requiredMemory, treeView, mapView, bytesMin, bytesMax, nodeCount, relationshipCount
----

.Results
[opts="header",cols="2,1,1,1,1"]
|===
| requiredMemory          | bytesMin | bytesMax | nodeCount | relationshipCount
| "[561 KiB ... 564 KiB]" | 574712   | 577896   | 100       | 1000
|===

The <<cypher-projection, `gds.graph.create.cypher`>> procedure has to execute both, the `nodeQuery` and `relationshipQuery`, in order to count the number of nodes and relationships of the graph.

.Syntax
[source, cypher]
----
CALL gds.graph.create.cypher.estimate(nodeQuery: String, relationshipQuery: String, configuration: Map})
YIELD requiredMemory, treeView, mapView, bytesMin, bytesMax, nodeCount, relationshipCount
----

.Parameters
[opts="header",cols="1,1,1,1,4"]
|===
| Name              | Type   | Default   | Optional  | Description
| nodeQuery         | string | -         | no        | The node query to estimate for.
| relationshipQuery | string | -         | no        | The relationship query to estimate for.
| config            | map    | {}        | yes       | Additional configuration, such as concurrency.
|===
